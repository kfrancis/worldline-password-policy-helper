# Password Policy Helper - Browser Extension

## Problem

Certain enterprise/government password reset pages (e.g., Ontario MOH/OHIP systems) enforce a non-standard password policy that rejects passwords generated by standard password managers like 1Password. The specific problematic rule is:

> **No character (case-sensitive) may appear more than 2 times in the password.**

For example: `AAxA` is rejected (uppercase `A` appears 3×), but `AAxa` is allowed (uppercase `A` appears 2×, lowercase `a` appears 1×).

Standard password managers generate long random passwords that inevitably repeat characters, causing frustrating rejection loops.

## Solution

A Chromium browser extension that:

1. **Detects** password fields on pages with this policy (or is manually triggered)
2. **Validates** a password against the full policy and highlights which rules fail
3. **Fixes** an existing password (e.g., from 1Password autofill) by substituting repeated characters while maintaining policy compliance
4. **Generates** a compliant password from scratch
5. **Copies** the result to clipboard so it can be saved back to 1Password

## Password Policy Rules

All of these must be satisfied simultaneously:

| # | Rule | Regex/Check |
|---|------|-------------|
| 1 | Minimum 8 characters | `length >= 8` |
| 2 | At least 1 uppercase letter | `/[A-Z]/` |
| 3 | At least 1 lowercase letter | `/[a-z]/` |
| 4 | At least 1 special character (`#?!@$%^&*-`) | `/[#?!@$%^&*\-]/` |
| 5 | At least 1 number | `/[0-9]/` |
| 6 | No character (case-sensitive) appears more than 2× | See below |

### Rule 6 Detail

Count occurrences of each character (case-sensitive). No character may have count > 2.

```
"AAxA"  → { A:3, x:1 } → FAIL (A appears 3×)
"aaXa"  → { a:3, X:1 } → FAIL (a appears 3×)
"AAxa"  → { A:2, x:1, a:1 } → PASS
"AXaa"  → { A:1, X:1, a:2 } → PASS
```

## Architecture

```
password-policy-helper/
├── manifest.json          # Manifest V3
├── popup/
│   ├── popup.html         # Main UI
│   ├── popup.css
│   └── popup.js           # UI logic
├── lib/
│   ├── validator.js       # Policy validation (all 6 rules)
│   ├── generator.js       # Compliant password generation
│   └── fixer.js           # Fix existing passwords to comply
├── content/
│   └── content.js         # Content script for page integration
└── icons/
    ├── icon-16.png
    ├── icon-48.png
    └── icon-128.png
```

## Key Behaviors

### Password Fixer (Primary Use Case - 1Password Workflow)

This is the most important feature. The user flow is:

1. User lands on password reset page
2. 1Password autofills or generates a password
3. Password is rejected due to rule 6
4. User clicks extension → "Fix Password" tab
5. Extension reads the password from the field (or user pastes it)
6. Extension identifies all characters appearing >2× 
7. For each excess occurrence, substitute with a random character from the same class (uppercase→random uppercase, lowercase→random lowercase, etc.) that does NOT already appear 2× in the password
8. Display the fixed password with changes highlighted
9. User clicks "Copy & Fill" → password is copied to clipboard AND filled into the field
10. User saves the new password in 1Password manually

### Password Generator

Generates a password of configurable length (default: 24) that satisfies all 6 rules:

**Algorithm:**
1. Build a character pool: `[A-Z]` + `[a-z]` + `[0-9]` + `#?!@$%^&*-`
2. Ensure at least 1 from each required class
3. Fill remaining length by picking random characters, but track counts and skip any character that already has count=2
4. Shuffle the result
5. Validate and retry if needed (edge case safety)

### Popup UI

- **Tab 1: Fix** — Text input pre-filled from active page's password field if possible, "Fix" button, shows result with diff highlighting, "Copy" and "Fill" buttons
- **Tab 2: Generate** — Length slider (8-40, default 24), "Generate" button, result display, "Copy" and "Fill" buttons  
- **Tab 3: Validate** — Paste/type a password, see real-time checklist of all 6 rules (green check / red X)
- All tabs show the same validation checklist below the result

### Content Script

- Injects a small icon/button next to password fields on the page
- Can read from and write to password input fields
- Communicates with popup via chrome.runtime messaging

## Tech Stack

- Vanilla JS (no framework needed, keep it simple)
- Manifest V3 (Chrome/Edge compatible)
- No external dependencies

## Testing

Include unit tests for:
- `validator.js` — test each rule individually and combined edge cases
- `generator.js` — generate 1000 passwords and validate all pass
- `fixer.js` — fix known-bad passwords and verify compliance + minimal changes